FROM registry.access.redhat.com/ubi8/ubi-minimal:latest

ARG MICRODIR=/microdir
ARG PIP_ROOT_USER_ACTION=ignore
ARG LANG=en_US.UTF-8
ARG LANGUAGE=en_US.UTF-8
ARG LC_COLLATE=C
ARG LC_CTYPE=en_US.UTF-8
ARG NLS_OS_CHARSET=AL32UTF8
ARG USE_GKE_GCLOUD_AUTH_PLUGIN=True

LABEL maintainer="ci.cd@ing.pl"

ENV PIP_ROOT_USER_ACTION=${PIP_ROOT_USER_ACTION} \
    LANG=${LANG} \
    LANGUAGE=${LANGUAGE} \
    LC_COLLATE=${LC_COLLATE} \
    LC_CTYPE=${LC_CTYPE} \
    NLS_OS_CHARSET=${NLS_OS_CHARSET} \
    USE_GKE_GCLOUD_AUTH_PLUGIN=${USE_GKE_GCLOUD_AUTH_PLUGIN}

WORKDIR /usr/src

RUN mkdir -p ${MICRODIR}

RUN dnf update -y && \
    dnf install -y curl dnf-utils gcc-c++ make python3-pip && \
    curl -fsSL https://rpm.nodesource.com/setup_21.x | bash - && \
    dnf install -y nodejs && \
    dnf clean all

RUN dnf install -y wget && \
    wget --no-check-certificate -O /usr/local/bin/jq -qc https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 && \
    chmod +x /usr/local/bin/jq && \
    dnf clean all

ENV NODE_TLS_REJECT_UNAUTHORIZED=0

COPY package*.json ./
RUN npm config set strict-ssl false && \
    npm install

COPY . .

COPY sample.env .env

CMD ["/bin/sh", "-c", "npm run test"]
