FROM node:20-alpine

WORKDIR /app

# Instalacja JDK 21 i niezbędnych narzędzi
RUN apk add --no-cache openjdk21-jre bash curl

# Ustawienie zmiennych środowiskowych
ENV NODE_TLS_REJECT_UNAUTHORIZED=0
ENV JAVA_HOME=/usr/lib/jvm/java-21-openjdk
ENV PATH=$JAVA_HOME/bin:$PATH

# Kopiowanie plików package.json i package-lock.json (jeśli istnieje)
COPY package*.json ./

# Instalacja zależności, w tym Gatling-JS
RUN npm install

# Kopiowanie reszty plików projektu
COPY . .

# Nadanie uprawnień do wykonywania skryptów
RUN chmod -R 755 /app/node_modules/.bin && \
    chmod -R 755 /app/src

# Tworzenie katalogu dla wyników testów Gatling
RUN mkdir -p /app/results && chmod 777 /app/results

# Tworzenie skryptu uruchamiającego
RUN echo '#!/bin/sh' > /app/entrypoint.sh && \
    echo 'npx ts-node src/helper && export $(grep -v "^#" .env | xargs) && npx gatling run' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# Ustawienie ENTRYPOINT na skrypt
ENTRYPOINT ["/app/entrypoint.sh"]
