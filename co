### Analiza procesu CI/CD dla testÃ³w wydajnoÅ›ciowych Gatling: Kompendium wiedzy

Ten dokument stanowi szczegÃ³Å‚owÄ… analizÄ™ potoku Continuous Integration/Continuous Delivery (CI/CD) stworzonego na potrzeby automatyzacji testÃ³w wydajnoÅ›ciowych Gatling. Proces ten, zdefiniowany w plikach `Dockerfile`, `azure-pipeline.yml` oraz playbookach Ansible (`docker_load.yml`, `send-test-results-mail.yml`), pozwala na kompleksowe zarzÄ…dzanie testami od momentu budowania obrazu, poprzez jego bezpieczne uruchomienie, aÅ¼ do finalnego raportowania wynikÃ³w. GÅ‚Ã³wnym celem jest zapewnienie **powtarzalnoÅ›ci, niezawodnoÅ›ci i efektywnoÅ›ci** cyklu testowania.

**Kluczowe pojÄ™cia:**

  * **CI/CD:** Metodologia automatyzacji, ktÃ³ra integruje zmiany w kodzie i dostarcza je do Å›rodowiska docelowego w sposÃ³b ciÄ…gÅ‚y i zautomatyzowany.
  * **Dockerfile:** Plik tekstowy, zawierajÄ…cy instrukcje do zbudowania **obrazu Docker** â€“ izolowanego, przenoÅ›nego Å›rodowiska, ktÃ³re zawiera wszystkie zaleÅ¼noÅ›ci (kod, biblioteki, Å›rodowisko uruchomieniowe) niezbÄ™dne do uruchomienia aplikacji.
  * **Azure Pipelines:** UsÅ‚uga chmurowa Azure DevOps, ktÃ³ra sÅ‚uÅ¼y jako **dyrygent** caÅ‚ego potoku. Odpowiada za planowanie, uruchamianie zadaÅ„ na agentach (wirtualnych maszynach) i monitorowanie ich statusu.
  * **Ansible:** NarzÄ™dzie do automatyzacji IT, wykorzystywane w tym procesie do **zdalnego zarzÄ…dzania serwerami**, na ktÃ³rych fizycznie uruchamiane sÄ… testy.

-----

### Diagramy ilustrujÄ…ce proces

PoniÅ¼sze diagramy majÄ… na celu wizualne przedstawienie struktury potoku i wzajemnych zaleÅ¼noÅ›ci miÄ™dzy jego komponentami.

#### Diagram 1: OgÃ³lny przepÅ‚yw potoku CI/CD

```mermaid
graph TD
    subgraph "Azure Pipelines"
        A[RozpoczÄ™cie potoku] --> B(Budowanie obrazu Docker)
        B --> C[WypchniÄ™cie do rejestru kontenerow]
    end
    subgraph "Zdalny Serwer"
        C --> D[Wdrozenie testow na serwerze]
        D --> E[Uruchomienie testow Gatling w kontenerze]
        E --> F[Pobranie wynikow i raportow]
    end
    subgraph "Azure Pipelines"
        F --> G[Wyslanie e-maila z raportem]
    end
```

**Opis diagramu:**

1.  **RozpoczÄ™cie potoku:** Zmiana w kodzie (commit) lub manualne uruchomienie potoku w Azure Pipelines.
2.  **Budowanie obrazu Docker:** Na agencie Azure DevOps uruchamiany jest proces budowania obrazu (`Dockerfile`).
3.  **WypchniÄ™cie obrazu:** Zbudowany obraz trafia do rejestru kontenerÃ³w (ACR).
4.  **WdroÅ¼enie testÃ³w:** W ramach tego samego potoku, playbook Ansible (`docker_load.yml`) wgrywa obraz na zdalny serwer i uruchamia go jako kontener.
5.  **Testowanie:** Kontener wykonuje testy Gatling, a ich wyniki sÄ… zapisywane wewnÄ…trz kontenera.
6.  **Pobieranie i analiza wynikÃ³w:** Wyniki sÄ… pobierane z kontenera na serwer, a nastÄ™pnie na agenta Azure.
7.  **Raportowanie:** Playbook Ansible (`send-test-results-mail.yml`) wysyÅ‚a e-mail z podsumowaniem wynikÃ³w.

#### Diagram 2: SzczegÃ³Å‚owy przepÅ‚yw w ramach zadania `ContainerScanningAndSync`

```mermaid
graph TD
    subgraph "Job: ContainerScanningAndSync"
        A[Start<br>zaleznosc od BuildDockerImage] --> B(Task: BSKContainerScanning@3)
        B --> C(Task: AzureKeyVault@1)
        C --> D(Task: Uruchomienie Ansible<br>ansible-playbook docker_load.yml)
        D --> E(Task: PublishTestResults@2)
        E --> F(Script: Ustawienie statusu)
        F --> G(Task: Wyslanie e-maila<br>ansible-playbook send-test-results-mail.yml)
    end
```

**Opis diagramu:**

1.  **Start:** Zadanie rozpoczyna siÄ™ po pomyÅ›lnym zbudowaniu obrazu.
2.  **Skanowanie:** Obraz jest skanowany pod kÄ…tem luk bezpieczeÅ„stwa (`BSKContainerScanning@3`).
3.  **Pobieranie sekretÃ³w:** Kluczowe dane (np. hasÅ‚a do aplikacji) sÄ… pobierane z Azure Key Vault (`AzureKeyVault@1`).
4.  **WdroÅ¼enie i testowanie:** Ansible uruchamia playbook `docker_load.yml`, ktÃ³ry zarzÄ…dza testami na zdalnym serwerze.
5.  **Publikacja raportu JUnit:** Zostaje opublikowany czytelny raport testÃ³w w Azure DevOps (`PublishTestResults@2`).
6.  **Ustawienie statusu:** Skrypt bash ustala status (`Success` / `Failure`) i kolor dla wiadomoÅ›ci e-mail.
7.  **WysÅ‚anie e-maila:** Ansible wywoÅ‚uje playbook `send-test-results-mail.yml` w celu wysÅ‚ania powiadomienia.

-----

### SzczegÃ³Å‚owy opis komponentÃ³w

#### 3.1. `Dockerfile` - Receptura Å›rodowiska testowego ğŸ‘¨â€ğŸ³

TwÃ³j `Dockerfile` jest przykÅ‚adem **najlepszych praktyk** w tworzeniu obrazÃ³w Docker. Stosuje on technikÄ™ **wieloetapowego budowania (multi-stage build)**, ktÃ³ra minimalizuje rozmiar koÅ„cowego obrazu i zwiÄ™ksza jego bezpieczeÅ„stwo.

**Etap 1: `builder`**

  * **`FROM registry.access.redhat.com/ubi8-minimal-as-builder`**: Wykorzystuje bezpieczny i minimalistyczny obraz UBI (Universal Base Image) od Red Hat, ktÃ³ry zawiera narzÄ™dzia deweloperskie.
  * **`RUN microdnf install ...`**: `microdnf` to menadÅ¼er pakietÃ³w w UBI. Instaluje wszystkie niezbÄ™dne narzÄ™dzia do kompilacji i zarzÄ…dzania kodem (`gcc-c++`, `git`, `npm`, `tar`). Jest to kluczowy etap, ktÃ³ry dostarcza Å›rodowisko do przygotowania Twoich testÃ³w.
  * **`RUN microdnf clean all ...`**: Oczyszcza system z tymczasowych plikÃ³w i cache, aby koÅ„cowy obraz byÅ‚ jak najmniejszy.

**Etap 2: `final`**

  * **`FROM registry.access.redhat.com/ubi8-minimal-as-final`**: Zaczyna od nowa, tym razem z obrazu, ktÃ³ry nie zawiera narzÄ™dzi deweloperskich. Jest to â€czystyâ€ obraz produkcyjny.
  * **`COPY --from=builder ...`**: Kopiuje tylko gotowe pliki z pierwszego etapu (np. skompilowane biblioteki, kod testÃ³w) do finalnego obrazu, pomijajÄ…c ciÄ™Å¼kie narzÄ™dzia deweloperskie.
  * **`USER 1001`**: Kluczowa instrukcja bezpieczeÅ„stwa. Tworzy i przeÅ‚Ä…cza uÅ¼ytkownika na `1001`, ktÃ³ry ma ograniczone uprawnienia. Zawsze naleÅ¼y unikaÄ‡ uruchamiania kontenerÃ³w jako `root`.
  * **`CMD ["/bin/bash", "-c", "npm run test"]`**: DomyÅ›lna komenda, ktÃ³ra zostanie wykonana, gdy kontener zostanie uruchomiony. Wymaga istnienia skryptu `test` w pliku `package.json`, ktÃ³ry wywoÅ‚uje testy Gatling (np. `gatling run ...`).

-----

#### 3.2. `azure-pipeline.yml` - Centralny mÃ³zg potoku ğŸ§ 

Ten plik definiuje caÅ‚y proces automatyzacji.

  * **`parameters`**: UmoÅ¼liwiajÄ… **parametryzacjÄ™ potoku**, co jest kluczowe dla elastycznoÅ›ci. Zmienne takie jak `gatlingUsers` mogÄ… byÄ‡ dostosowywane przed kaÅ¼dym uruchomieniem.
  * **`stages: Build`**: Potok jest podzielony na logiczne etapy.
      * **`job: BuildDockerImage`**:
          * **`pool: vmImage: 'ubuntu-latest'`**: Zadanie jest wykonywane na agencie Azure Pipelines.
          * **`task: Docker@2`**: Wbudowane zadanie Azure DevOps.
              * `command: 'buildAndPush'`: Buduje obraz na podstawie `Dockerfile` i wypycha go do **Azure Container Registry (ACR)**.
      * **`job: ContainerScanningAndSync`**:
          * **`dependsOn: BuildDockerImage`**: Ta instrukcja tworzy **zaleÅ¼noÅ›Ä‡**. Zadanie to rozpocznie siÄ™ tylko, gdy `BuildDockerImage` zakoÅ„czy siÄ™ sukcesem.
          * **`task: BSKContainerScanning@3`**: Integracja z zewnÄ™trznym skanerem bezpieczeÅ„stwa, ktÃ³ry sprawdza obraz pod kÄ…tem luk.
          * **`task: AzureKeyVault@1`**: Bezpiecznie pobiera poufne dane (hasÅ‚a, klucze API) z **Azure Key Vault**, chroniÄ…c je przed przechowywaniem w kodzie.
          * **`task: Copy onboard integration to stlx04021`**: To zadanie wywoÅ‚uje skrypt, ktÃ³ry uruchamia playbook Ansible **`docker_load.yml`**. Jest to moment, w ktÃ³rym kontrola zostaje przekazana do zdalnego hosta.
          * **`task: PublishTestResults@2`**: Pobiera plik `junit_report_from_log.xml` i **parsuje go**, tworzÄ…c czytelny raport w Azure DevOps.
          * **`script`**: Skrypt w Bashu, ktÃ³ry na podstawie statusu zadaÅ„ (np. `Agent.JobStatus`) ustawia zmienne `STATUS` i `STATUS_COLOR`.
          * **`ansible-playbook scripts/send-test-results-mail.yml`**: Na koÅ„cu, potok wywoÅ‚uje playbook **`send-test-results-mail.yml`**, ktÃ³ry uÅ¼ywa zebranych zmiennych do wysÅ‚ania e-maila.

-----

#### 3.3. `docker_load.yml` - Operator na zdalnym serwerze âš™ï¸

To playbook Ansible, ktÃ³ry wykonuje operacje na docelowym serwerze testowym.

  * **`hosts: all`**: Playbook jest wykonywany na wszystkich hostach zdefiniowanych w inwentarzu.
  * **`become: yes`**: UmoÅ¼liwia uruchamianie zadaÅ„ z podwyÅ¼szonymi uprawnieniami (np. `root`), co jest niezbÄ™dne do zarzÄ…dzania kontenerami.
  * **`tasks`**:
      * **`Load Docker image from the found folder`**: Zamiast `docker pull`, uÅ¼ywa **`podman load`**. **Podman** jest alternatywÄ… dla Dockera, ktÃ³ra dziaÅ‚a bez demona, co zwiÄ™ksza bezpieczeÅ„stwo.
      * **`Run Docker/Podman image in detached mode...`**: Kluczowy task, ktÃ³ry uruchamia kontener w tle (`-d`). Przekazuje do niego **zmienne Å›rodowiskowe** (np. `GATLING_USERS`), ktÃ³re sterujÄ… testami.
      * **`Wait for the container to complete...`**: Ta instrukcja sprawia, Å¼e Ansible **blokuje** dalsze wykonanie, dopÃ³ki kontener nie zakoÅ„czy dziaÅ‚ania.
      * **`Copy JUnit report from container...`**: Wyniki sÄ… kopiowane z kontenera na serwer, a nastÄ™pnie `Fetch JUnit report` pobiera je na agenta Azure Pipelines.
      * **`Global cleanup of all Podman/Docker containers...`**: **Konieczny etap czyszczenia**. Zatrzymuje i usuwa wszystkie nieuÅ¼ywane kontenery i obrazy, by utrzymaÄ‡ serwer w czystoÅ›ci i zapobiec wyczerpaniu zasobÃ³w.

-----

#### 3.4. `send-test-results-mail.yml` - Komunikator wynikÃ³w ğŸ“¬

Ostatni krok w potoku, ktÃ³ry zapewnia komunikacjÄ™.

  * **`hosts: local`**: Playbook jest wykonywany na agencie Azure Pipelines, gdzie dostÄ™pne sÄ… wszystkie dane.
  * **`tasks`**:
      * **`name: Send email about test results`**: UÅ¼ywa moduÅ‚u `community.general.mail`.
      * `subject`: TytuÅ‚ wiadomoÅ›ci jest **dynamiczny** (`{{ status }}`).
      * `body`: TreÅ›Ä‡ wiadomoÅ›ci jest w **HTML**, co pozwala na uÅ¼ycie kolorÃ³w (`{{ status_color }}`) i linkÃ³w.
      * `attach`: Do wiadomoÅ›ci doÅ‚Ä…czane jest spakowane archiwum z raportami, co uÅ‚atwia dostÄ™p do peÅ‚nych wynikÃ³w.

-----

### WskazÃ³wki do odtworzenia procesu

1.  **Przepakuj swoje testy do Dockera:** Upewnij siÄ™, Å¼e TwÃ³j `Dockerfile` poprawnie kopiuje kod testÃ³w i Å¼e polecenie `CMD` uruchamia je prawidÅ‚owo.
2.  **Dostosuj parametry:** W `azure-pipeline.yml` zmieÅ„ nazwy repozytoriÃ³w, pul agentÃ³w i adresy e-mail na swoje.
3.  **Dopasuj Å›cieÅ¼ki i nazwy:** W `docker_load.yml` dostosuj nazwy plikÃ³w raportÃ³w i Å›cieÅ¼ki na serwerze, jeÅ›li rÃ³Å¼niÄ… siÄ™ od domyÅ›lnych.
4.  **Upewnij siÄ™, Å¼e Ansible moÅ¼e poÅ‚Ä…czyÄ‡ siÄ™ z serwerem:** Skonfiguruj inwentarz i uprawnienia SSH, aby agent Azure DevOps mÃ³gÅ‚ zarzÄ…dzaÄ‡ zdalnym serwerem.
5.  **Dopasuj adresy e-mail:** Zaktualizuj adresy `to` i `from` w `send-test-results-mail.yml` zgodnie z Twoimi potrzebami.

Ten proces jest wzorowym przykÅ‚adem **automatyzacji od poczÄ…tku do koÅ„ca**, ktÃ³ra obejmuje budowanie, bezpieczeÅ„stwo, wdroÅ¼enie, testowanie i komunikacjÄ™.
