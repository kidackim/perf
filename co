import { execSync } from 'child_process';
import { existsSync, readdirSync, statSync } from 'fs';
import { join } from 'path';

function findLatestDir(baseDir) {
  const dirs = readdirSync(baseDir, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory() && dirent.name.startsWith('jssimulation-'))
    .map(dirent => ({
      name: dirent.name,
      path: join(baseDir, dirent.name),
      time: statSync(join(baseDir, dirent.name)).mtime.getTime(),
    }))
    .sort((a, b) => b.time - a.time);

  return dirs.length > 0 ? dirs[0].path : null;
}

async function main() {
  const GATLING_DIR = 'target/gatling';

  if (!existsSync(GATLING_DIR)) {
    console.error(`Błąd: Katalog ${GATLING_DIR} nie istnieje.`);
    process.exit(1);
  }

  const LATEST_DIR = findLatestDir(GATLING_DIR);

  if (!LATEST_DIR) {
    console.error(`Błąd: Nie znaleziono katalogów jssimulation-* w ${GATLING_DIR}.`);
    process.exit(1);
  }

  console.log(`Znaleziono najnowszy katalog: ${LATEST_DIR}`);

  const STATS_FILE = join(LATEST_DIR, 'js', 'stats.js');

  if (!existsSync(STATS_FILE)) {
    console.error(`Błąd: Nie znaleziono pliku ${STATS_FILE}.`);
    process.exit(1);
  }

  console.log(`Znaleziono plik stats.js: ${STATS_FILE}`);

  const XML_FILE = 'TEST-gatling-results.xml';

  try {
    console.log('Generowanie raportu XML...');
    execSync(`node toXML.mjs "${STATS_FILE}" "${XML_FILE}"`, { stdio: 'inherit' });

    if (!existsSync(XML_FILE)) {
      console.error(`Błąd: Nie udało się wygenerować pliku ${XML_FILE}.`);
      process.exit(1);
    }

    console.log(`Raport XML został wygenerowany: ${XML_FILE}`);

    const HTML_FILE = 'gatling-report.html';

    console.log('Generowanie raportu HTML...');
    execSync(`node toHTML.mjs "${XML_FILE}" "${HTML_FILE}"`, { stdio: 'inherit' });

    if (!existsSync(HTML_FILE)) {
      console.error(`Błąd: Nie udało się wygenerować pliku ${HTML_FILE}.`);
      process.exit(1);
    }

    console.log(`Raport HTML został wygenerowany: ${HTML_FILE}`);
    console.log('Proces zakończony pomyślnie.');
  } catch (error) {
    console.error('Błąd podczas generowania raportów:', error);
    process.exit(1);
  }
}

main();
