- name: Run Docker/Podman image in detached mode and get container ID
  ansible.builtin.command:
    argv:
      - podman
      - run
      - -d
      - -e
      - "DB_PASSWORD={{ DB_PASSWORD }}"
      - -e
      - "KEYCLOAK_TOKEN_PASSWORD={{ KEYCLOAK_TOKEN_PASSWORD }}"
      - "{{ image_to_run_name }}"
      - /bin/bash
      - -c
      - |
        jq --arg password "${DB_PASSWORD}" --arg keycloak_tokenPassword "${KEYCLOAK_TOKEN_PASSWORD}" '.password = "\$password" | .keycloak_tokenPassword = "\$keycloak_tokenPassword"' /e2e/cypress.env.json > /tmp/temp.json && mv /tmp/temp.json /e2e/cypress.env.json && cypress run --browser electron --headless --reporter mocha-junit-reporter

  register: run_container_detached_result

- name: Wait for the container to complete its task
  ansible.builtin.command:
    cmd: "podman wait {{ run_container_detached_result.stdout }}"

- name: Check container exit code
  ansible.builtin.command:
    cmd: "podman inspect --format='{{ .State.ExitCode }}' {{ run_container_detached_result.stdout }}"
  register: container_exit_code

- name: Assert successful test run
  ansible.builtin.assert:
    that:
      - container_exit_code.stdout | int == 0
    fail_msg: "Test container exited with non-zero code. Check logs for details."

- name: Watch container logs
  ansible.builtin.command:
    cmd: "podman logs {{ run_container_detached_result.stdout }}"
  register: container_logs
  ignore_errors: true
