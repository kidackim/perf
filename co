# Etap 1: Builder - instalacja wszystkich zależności
# Użyj oficjalnego obrazu Cypressa, który zawiera Node.js i wszystkie niezbędne narzędzia.
FROM cypress/base:20 AS cypress-builder

# Ustaw katalog roboczy w tym etapie
WORKDIR /app

# Skopiuj pliki package.json i package-lock.json
COPY package*.json ./

# Zainstaluj zależności, w tym Cypressa
RUN npm install

# Weryfikacja instalacji w etapie budowania
RUN npm run cypress -- --version

#-------------------------------------------------------------------------------------------------------

# Etap 2: Finalny obraz - przenoszenie plików
# Użyj swojego obrazu bazowego Red Hat ubi-minimal
FROM registry.access.redhat.com/ubi8/ubi-minimal

# Ustaw katalog roboczy w finalnym obrazie
WORKDIR /app

# Skopiuj folder node_modules z buildera do finalnego obrazu
# Ta komenda przenosi wszystkie zainstalowane pakiety bez potrzeby ich ponownego pobierania.
COPY --from=cypress-builder /app/node_modules /app/node_modules

# Opcjonalnie, skopiuj inne pliki projektu (np. testy)
COPY . .

# Uruchom Cypressa - komenda działa, ponieważ wszystko zostało już skopiowane
CMD ["./node_modules/.bin/cypress", "run"]
