// Plik: cypress/support/lolek_commands_hce.js

const RENGWEB_URL = 'https://hce-u.pl.ing-ad/'; 

Cypress.Commands.add('login', (username, password) => {
    return cy.api({
        method: 'POST',
        url: RENGWEB_URL + 'auth/realms/ING_MAIN/protocol/openid-connect/token',
        failOnStatusCode: false,
        body: {
            grant_type: 'password',
            username: username,
            password: password
        }
    });
});

Cypress.Commands.add('rengchildinappverify', (authToken, tokenUniqueReferenceId, token = 'kod128le') => {
    const VERIFY_PAYLOAD = {
        token: token,
        tokenUniqueReferenceId: tokenUniqueReferenceId,
        locale: 'PL'
    };
    
    return cy.api({
        method: 'POST',
        url: RENGWEB_URL + 'api/google/child/inapp/verify',
        failOnStatusCode: false,
        headers: Utils.getHeadersWithSessionId(authToken), 
        body: VERIFY_PAYLOAD
    });
});

Cypress.Commands.add('rengchildinappcheck', (authToken, payload, sessionId) => {
    return cy.api({
        method: 'POST',
        url: RENGWEB_URL + 'api/google/child/inapp/check',
        failOnStatusCode: false,
        headers: Utils.getHeadersWithSessionId(sessionId, authToken),
        body: payload
    });
});

// Plik: cypress/support/commands.d.ts

declare namespace Cypress {
    interface Chainable<Subject> {
        /**
         * Loguje użytkownika do systemu (auth/token).
         * @param username - Nazwa użytkownika.
         * @param password - Hasło użytkownika.
         */
        login(username: string, password: string): Chainable<any>;

        /**
         * Weryfikuje token zakupu (api/google/child/inapp/verify).
         * @param authToken - Token uwierzytelniający.
         * @param tokenUniqueReferenceId - ID referencyjne tokenu zakupu (np. DINGMC1PL...).
         * @param [token='kod128le'] - Token zakupu.
         */
        rengchildinappverify(authToken: string, tokenUniqueReferenceId: string, token?: string): Chainable<any>;

        /**
         * Sprawdza uprawnienia (api/google/child/inapp/check).
         * @param authToken - Token uwierzytelniający.
         * @param payload - Całe ciało żądania (dane dziecka/rodzica).
         * @param sessionId - ID sesji (jeśli wymagane w nagłówkach).
         */
        rengchildinappcheck(authToken: string, payload: object, sessionId: string): Chainable<any>;
    }
}


// Plik: cypress/e2e/test-framework-hce.spec.cy.js

const TEST_USERNAME = '89002077';
const TEST_PASSWORD = 'BSHGQU9d7mCY1yNzH';
const EXPECTED_ELIGIBILITY_STATUS = 'ELIGIBLE'; 

const GREEN_PATH_DATA = {
    "BEAP103125": {
        "card128id": "AAc8AACDED71191F37049555CAE6B60900AAF2CD683B566801E6CCD0105F6A6D8AC9A8BCDD7C95C950922A74CBC8B823B86EF8B5CA6ED68EF13785CC6E9AC8AB",
        "wklUser": "221N100596",
        "wklOwner": "2210206900",
        "sourceUsername": "BEAP103125",
        "wkl_purpose_description": "parent for user for green path"
    }
};

let token;
let sessionId;

describe('API Setup and Authorization', () => {

    it('should successfully login and get token/session ID', () => {
        // Użycie login(username, password)
        cy.login(TEST_USERNAME, TEST_PASSWORD).then((response) => { 
            expect(response.status).to.eq(200);
            token = response.body.access_token; 
            sessionId = response.body.session_state; 
            expect(token).to.not.be.undefined;
        });
    });
});

describe('Google Play Child API Verification & Check', () => {

    it('should pass inapp verification check for a valid token reference (Postman)', () => {
        const VALID_TOKEN_REF = 'DINGMC1PL000000e4f2257997334bdbdbb232f45ec7caae7';

        // Użycie rengchildinappverify(authToken, tokenRef)
        cy.rengchildinappverify(token, VALID_TOKEN_REF).then((response) => {
            expect(response.status).to.eq(200);
            expect(response.body.status).to.eq('OK');
            expect(response.body.code).to.be.null;
        });
    });

    it('should correctly process the "parent for user for green path" data (NEW TEST)', () => {
        
        // Użycie rengchildinappcheck(authToken, payload, sessionId)
        cy.rengchildinappcheck(token, GREEN_PATH_DATA, sessionId).then((response) => {
            const mainKey = Object.keys(response.body)[0];

            expect(response.status).to.eq(200);
            expect(response.body[mainKey].eligibility_status).to.eq(EXPECTED_ELIGIBILITY_STATUS);
            expect(response.body[mainKey].wklOwner).to.eq(GREEN_PATH_DATA[mainKey].wklOwner);
        });
    });
    
    it('should return an error for an invalid/non-existent tokenUniqueReferenceId (Negative)', () => {
        const INVALID_TOKEN_REF = 'INVALID_REF_12345'; 

        // Użycie rengchildinappverify(authToken, invalidTokenRef)
        cy.rengchildinappverify(token, INVALID_TOKEN_REF).then((response) => {
            expect(response.status).to.eq(200); 
            expect(response.body.status).to.eq('ERROR');
            expect(response.body.code).to.not.be.null; 
        });
    });
});
