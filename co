# azure-pipeline.yml

stages:
- stage: Build
  displayName: 'Build'
  jobs:
  - job: BuildDockerImage
    displayName: 'Build Docker Image'
    pool:
      vmImage: 'ubuntu-latest' # Używa agenta Microsoft Hosted Agent
    steps:
    - task: Docker@2
      displayName: 'Build and Push image to ACR'
      inputs:
        containerRegistry: 'P08399-hceacr-ACR-write'
        repository: 'P08399/gatling-test'
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        # ZMIANA: Użycie dynamicznego taga dla obrazu
        tags: '$(Build.BuildId)'
        # Możesz również dodać tag ':latest' aby zawsze wskazywał na najnowszą udaną kompilację
        # tags: '$(Build.BuildId),latest'

  - job: ContainerScanningAndSync
    displayName: 'Container Scanning and Sync'
    dependsOn: BuildDockerImage # Upewnij się, że ten job czeka na zakończenie budowania obrazu
    pool:
      # Upewnij się, że ta pula agentów jest dostępna i ma potrzebne uprawnienia
      name: BSK-only-agent-pool
    steps:
    - task: CdaasContainerSync@2
      displayName: 'Copy gatling-test:$(Build.BuildId) to BSK Harbor registry'
      inputs:
        # ZMIANA: Odwołanie do obrazu z dynamicznym tagiem
        imageName: 'p08399hceacr.azurecr.io/p08399/gatling-test:$(Build.BuildId)'
        sourceEndpoint: 'P08399-hceacr-ACR-read'
        targetCredentials: 'serviceconnection'
        targetRepository: 'p08399-Harbor-push'

    - task: BoiContainerScanning@3
      displayName: 'Scan Container'
      continueOnError: true # Kontynuuj pipeline nawet jeśli skanowanie znajdzie podatności
      inputs:
        scanningRegistry: 'acr'
        scanningServiceEndpoint: 'P08399-BSK-Prisma-SC'
        ACREndpoint: 'P08399-hceacr-ACR-read'
        Image: 'p08399/gatling-test'
        # ZMIANA: Odwołanie do obrazu z dynamicznym tagiem
        Tag: '$(Build.BuildId)'
