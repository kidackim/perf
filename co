#!/bin/bash

# Ścieżka do pliku package.json
PACKAGE_JSON="/app/package.json"

# Katalog docelowy dla Gatling
GATLING_DIR="/opt/gatling"

# Sprawdzenie czy package.json istnieje
if [ ! -f "$PACKAGE_JSON" ]; then
  echo "Błąd: Nie znaleziono pliku package.json w ścieżce $PACKAGE_JSON"
  exit 1
fi

# Wyciągnięcie wersji Gatling z package.json
# Zakładamy, że wersja jest zapisana w formacie "gatling": "3.10.5" lub jako zależność
GATLING_VERSION=$(grep -o '"gatling":[[:space:]]*"[^"]*"' "$PACKAGE_JSON" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' || echo "")

# Jeśli nie znaleziono bezpośrednio, szukaj w dependencies lub devDependencies
if [ -z "$GATLING_VERSION" ]; then
  GATLING_VERSION=$(grep -o '"gatling":[[:space:]]*"[^"]*"' "$PACKAGE_JSON" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' || echo "")
fi

# Jeśli nadal nie znaleziono, użyj domyślnej wersji
if [ -z "$GATLING_VERSION" ]; then
  echo "Nie znaleziono wersji Gatling w package.json, używam domyślnej wersji 3.10.5"
  GATLING_VERSION="3.10.5"
else
  echo "Znaleziono wersję Gatling: $GATLING_VERSION"
fi

# Tworzenie katalogów
mkdir -p "$GATLING_DIR"
mkdir -p /tmp/downloads
mkdir -p /tmp/archive

# Pobieranie i rozpakowywanie Gatling
echo "Pobieranie Gatling w wersji $GATLING_VERSION..."
wget -q -O /tmp/downloads/gatling-$GATLING_VERSION.zip \
  https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/$GATLING_VERSION/gatling-charts-highcharts-bundle-$GATLING_VERSION-bundle.zip

if [ $? -ne 0 ]; then
  echo "Błąd: Nie udało się pobrać Gatling w wersji $GATLING_VERSION"
  exit 1
fi

echo "Rozpakowywanie Gatling..."
unzip -q /tmp/downloads/gatling-$GATLING_VERSION.zip -d /tmp/archive
mv /tmp/archive/gatling-charts-highcharts-bundle-$GATLING_VERSION/* "$GATLING_DIR/"
chmod -R 755 "$GATLING_DIR"

# Czyszczenie
rm -rf /tmp/downloads /tmp/archive

# Ustawienie zmiennych środowiskowych
echo "export GATLING_HOME=$GATLING_DIR" >> /etc/profile.d/gatling.sh
echo "export PATH=\$PATH:$GATLING_DIR/bin" >> /etc/profile.d/gatling.sh
chmod +x /etc/profile.d/gatling.sh

echo "Gatling został pomyślnie zainstalowany w $GATLING_DIR"
