# playbooks/docker_load.yml

- name: Dynamically find and load Docker image
  hosts: all
  gather_facts: false

  # === ZMIENIONE LINIE ===
  become: true         # Włącz użycie podnoszenia uprawnień
  become_user: root    # <-- Uruchom CAŁY play jako root
  become_method: sudo  # Użyj metody sudo
  # ========================

  vars:
    base_docker_path: "/app/docker/images"
    build_id_from_pipeline: "{{ build_id }}"

  tasks:
    # --- Task diagnostyczny (do usunięcia po weryfikacji) ---
    - name: Verify current user and groups
      ansible.builtin.shell: |
        whoami
        id
        groups
      register: user_info

    - name: Display current user and groups
      ansible.builtin.debug:
        msg: |
          "Current user: {{ user_info.stdout }}"
          "User ID info: {{ user_info.stdout_lines[1] | default('N/A') }}"
          "User groups: {{ user_info.stdout_lines[2] | default('N/A') }}"
    # --------------------------------------------------------

    - name: Find the exact Docker image folder name
      ansible.builtin.find:
        paths: "{{ base_docker_path }}"
        file_type: directory
        patterns: "skopeoCopy-gatling-test-{{ build_id_from_pipeline }}*"
        recurse: false
      register: found_docker_folders

    - name: Set fact for found folder path
      ansible.builtin.set_fact:
        full_docker_folder_path: "{{ found_docker_folders.files[0].path if found_docker_folders.files | length > 0 else omit }}"
      when: found_docker_folders.files | length > 0

    - name: Fail if no Docker image folder was found
      ansible.builtin.fail:
        msg: "ERROR: Could not find Docker image folder starting with skopeoCopy-gatling-test-{{ build_id_from_pipeline }} in {{ base_docker_path }}"
      when: full_docker_folder_path is not defined

    - name: Load Docker image from the found folder
      ansible.builtin.shell: |
        docker load -i "{{ full_docker_folder_path }}/gatling-test-{{ build_id_from_pipeline }}.tar"
      args:
        chdir: "{{ full_docker_folder_path }}"
      when: full_docker_folder_path is defined
      # Tutaj nie musisz dodawać become: true, bo jest już na poziomie play i będzie wykonywane jako root
