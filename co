steps:
- task: Ansible@1
  displayName: 'Send Dynamic Test Results Email with Ansible'
  inputs:
    playbookFile: 'playbooks/scripts/send-test-results-mail.yml'
    inventoryHosts: 'localhost,'
    vars:
      smtp_host: '$(parameters.smtpHost)'
      smtp_port: '$(parameters.smtpPort)'
      mail_from: '$(parameters.mailFrom)'
      mail_to: '$(parameters.recipient1),$(parameters.recipient2),$(parameters.recipient3)'
      mail_status: >
        {% if variables['Agent.JobStatus'] == 'Succeeded' %}
        Success
        {% elif variables['Agent.JobStatus'] == 'Failed' %}
        Failure
        {% else %}
        Warning
        {% endif %}
      mail_status_color: >
        {% if variables['Agent.JobStatus'] == 'Succeeded' %}
        green
        {% elif variables['Agent.JobStatus'] == 'Failed' %}
        red
        {% else %}
        orange
        {% endif %}
      build: '$(Build.BuildNumber)'
      project_url: 'https://dev.azure.com/IngEurCdaaS01/IngOne/_build/results?buildId=$[Build.BuildId]'
      attachments:
      - '$(System.DefaultWorkingDirectory)/playbooks/fetched_reports/junit_report_from_log.xml'
      - '$(System.DefaultWorkingDirectory)/playbooks/fetched_target_archive/archive.zip'
  condition: always()
